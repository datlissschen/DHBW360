name: Code Analysis and build + deploy Frontend & Backend services

on:
    push:
        branches: ['main']
    workflow_dispatch:

jobs:
    automated-tests:
        name: Game-Service Integration Tests
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '22'
            - name: Install backend dependencies
              run: npm ci
              working-directory: backend
            - name: Run Integration Tests
              run: npm test
              working-directory: backend/game-service
              env:
                  PRODUCTION: false
                  SESSION_SECRET: abc123
                  S3_REGION: ${{ secrets.S3_REGION }}
                  S3_BUCKET_NAME: ${{ secrets.S3_BUCKET_NAME }}
                  S3_ACCESS_KEY: ${{ secrets.S3_ACCESS_KEY }}
                  S3_SECRET_KEY: ${{ secrets.S3_SECRET_KEY }}
                  SCORE_SERVICE_API: http://127.0.0.1:8082

    build-and-deploy:
        name: Build and deploy
        runs-on: ubuntu-latest
        needs: automated-tests
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Node.js
              uses: actions/setup-node@v3
              with:
                  node-version: '22'

            # --- FRONTEND BUILD ---
            - name: Install and Build Frontend
              run: |
                  cd frontend
                  npm ci --force
                  npm run build:prod

            # --- BACKEND BUILD ---
            - name: Install and Build Backend
              run: |
                  cd backend
                  npm ci
                  npm run build:all

            - name: Prepare Deployment Bundle
              run: |
                  # 1. Create temporary deployment folder
                  mkdir -p deploy/frontend
                  mkdir -p deploy/backend/game-service
                  mkdir -p deploy/backend/score-service
                  
                  # 2. Copy frontend files
                  cp frontend/package.json deploy/frontend/
                  cp frontend/Dockerfile deploy/frontend/
                  cp frontend/nginx.conf deploy/frontend/
                  cp -r frontend/dist deploy/frontend/
                  
                  # 3. Copy backend package.json to deploy folder
                  cp backend/package.json deploy/backend/
                  
                  # Game Service
                  cp backend/game-service/Dockerfile deploy/backend/game-service/
                  cp -r backend/game-service/dist deploy/backend/game-service/
                  
                  # Score Service
                  cp backend/score-service/Dockerfile deploy/backend/score-service/
                  cp -r backend/score-service/dist deploy/backend/score-service/
                  
                  # 4. Copy docker-compose.yml to deploy folder
                  cp docker/docker-compose.yml deploy/
                  
                  # 5. Create archive (tar.gz)
                  tar -czf deployment-package.tar.gz -C deploy .

            # --- UPLOAD & DEPLOY ---
            - name: Upload Single Bundle
              uses: appleboy/scp-action@v0.1.7
              with:
                  host: vsv-research.volkmann-webservices.de
                  username: tinf24b
                  key: ${{ secrets.DEPLOY_KEY }}
                  source: "deployment-package.tar.gz"
                  target: "/home/tinf24b/dhbw360/"

            - name: Unpack and Restart Docker
              uses: appleboy/ssh-action@v1.0.3
              with:
                  host: vsv-research.volkmann-webservices.de
                  username: tinf24b
                  key: ${{ secrets.DEPLOY_KEY }}
                  script: |
                      cd /home/tinf24b/dhbw360
                      
                      # Unzip archive, overwrites local files
                      tar -xzf deployment-package.tar.gz
                      
                      # Delete archive
                      rm deployment-package.tar.gz
                      
                      # Docker restart
                      docker compose down
                      docker compose up -d --build
