<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHBW360 - Standortauswahl (Gesperrte Schritte)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #930010;
            --link-highlight: #C30012;
            --button-hover: #7a000d;
            --text-dark: #333333;
            --text-strong: #000000;
            --text-medium: #777777;
            --text-light: #FFFFFF;
            --bg-light: #FFFFFF;
            --bg-dark: #F5F5F5;
            --popup-bg-color: rgba(0, 0, 0, 0.6);
            --popup-content-bg: var(--bg-dark);
            --step-bg: var(--bg-light);
            --border-light: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --border-radius: 12px;
            --popup-border-radius: 20px;
        }

        html, body {
            margin: 0; padding: 0; height: 100%;
            font-family: 'Poppins', sans-serif;
            color: var(--text-dark);
            overflow: hidden;
        }

        .background-360-view {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('https://via.placeholder.com/1920x1080/404040/FFFFFF?text=360%C2%B0+Background+View');
            background-size: cover; background-position: center;
            filter: grayscale(30%) blur(2px);
            z-index: -1;
        }

        .header {
            position: absolute; top: 0; left: 0;
            width: 100%; padding: 1.5rem 2rem; z-index: 10;
        }
        .header .logo-text {
            font-size: 1.5rem; font-weight: 700;
            color: var(--text-light);
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .popup-overlay {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--popup-bg-color);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
        }

        .popup-content {
            background-color: var(--popup-content-bg);
            padding: 2.5rem 3rem;
            border-radius: var(--popup-border-radius);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            width: 90%; max-width: 900px;
            height: 90%; max-height: 800px;
            display: flex; flex-direction: column;
            color: var(--text-strong);
            position: relative;
        }

        .popup-header {
            display: flex; justify-content: space-between; align-items: flex-start;
            margin-bottom: 1.5rem;
        }
        .popup-header h2 {
            font-size: 1.8rem; font-weight: 700;
            color: var(--primary-color); margin: 0;
        }
        .close-button {
            background: none; border: none;
            font-size: 2.5rem; line-height: 1;
            color: var(--text-strong); cursor: pointer;
            position: absolute; top: 1.5rem; right: 1.5rem;
            transition: color 0.2s ease;
        }
        .close-button:hover { color: var(--primary-color); }

        .steps-container {
            flex-grow: 1; overflow-y: auto;
            display: flex; flex-direction: column;
            gap: 1rem;
        }
        
        .step {
            background-color: var(--step-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .step-header {
            padding: 1rem 1.5rem;
            cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
            list-style: none;
            transition: background-color 0.2s ease;
        }
        .step-header:hover {
            background-color: var(--bg-dark);
        }

        /* --- NEU: Deaktivierter Schritt --- */
        .step.disabled > .step-header {
            cursor: not-allowed;
            background-color: var(--bg-dark);
            opacity: 0.6;
            pointer-events: none; /* Verhindert Klicks */
        }
        /* Sicherstellen, dass deaktivierte Schritte nicht manuell geöffnet werden können */
        .step.disabled {
            pointer-events: none;
        }
        .step.disabled > .step-content {
            display: none;
        }
        /* --- Ende Neu --- */

        .step-header h3 {
            margin: 0; font-size: 1.2rem; font-weight: 600;
            color: var(--text-dark);
        }

        .step-status {
            font-size: 0.9rem; font-weight: 600;
            color: var(--text-medium);
        }
        .step-status.selected {
            color: var(--primary-color);
        }
        
        .step-header::after {
            content: '▼'; font-size: 0.8rem;
            color: var(--text-medium);
            transition: transform 0.2s ease;
        }
        
        .step[open] > .step-header {
            border-bottom: 1px solid var(--border-light);
        }
        .step[open] > .step-header::after {
            transform: rotate(180deg);
        }

        .step-content {
            padding: 1.5rem;
            display: flex; flex-direction: column;
            gap: 1rem;
            pointer-events: all; /* Klicks im Inhalt erlauben, auch wenn .step disabled ist */
        }

        .map-container {
            width: 100%; height: 350px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-light);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .map-controls {
            display: flex; align-items: center; gap: 1.5rem;
        }
        .map-controls button {
            background-color: var(--bg-light);
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem; cursor: pointer;
            font-weight: 600; color: var(--text-dark);
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        .map-controls button.active,
        .map-controls button:hover {
            background-color: var(--primary-color);
            color: var(--text-light);
            border-color: var(--primary-color);
        }

        .submit-button {
            align-self: flex-end;
            background-color: var(--link-highlight);
            color: var(--text-light);
            padding: 0.8rem 2.5rem; border: none;
            border-radius: var(--border-radius);
            font-size: 1.1rem; font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-shadow: var(--shadow);
            margin-top: 1.5rem;
        }
        .submit-button:hover {
            background-color: var(--button-hover);
            transform: translateY(-2px);
        }
        
        .geojson-polygon-highlight {
            fillColor: var(--link-highlight);
            fillOpacity: 0.7;
            stroke: var(--primary-color);
        }
    </style>
</head>
<body>

    <div class="background-360-view"></div>

    <header class="header">
        <span class="logo-text">DHBW360</span>
    </header>

    <div class="popup-overlay">
        <div class="popup-content">
            <div class="popup-header">
                <h2>Standortauswahl</h2>
                <button class="close-button" id="closeButton">&times;</button>
            </div>

            <div class="steps-container">
                <details class="step" id="step-1" open>
                    <summary class="step-header">
                        <h3>Schritt 1: Standort auf Karte wählen</h3>
                        <span class="step-status" id="status-step-1">Nicht ausgewählt</span>
                    </summary>
                    <div class="step-content">
                        <div class="map-controls">
                            <button class="map-type-button active" data-map="world" data-type="karte">Karte</button>
                            <button class="map-type-button" data-map="world" data-type="satellit">Satellit</button>
                        </div>
                        <div id="map-world" class="map-container"></div>
                    </div>
                </details>

                <details class="step disabled" id="step-2">
                    <summary class="step-header">
                        <h3>Schritt 2: Etage auswählen</h3>
                        <span class="step-status" id="status-step-2">Nicht ausgewählt</span>
                    </summary>
                    <div class="step-content">
                        <p>Wähle den Gebäudeteil auf dem Grundriss aus.</p>
                        <div id="map-floor" class="map-container"></div>
                    </div>
                </details>

                <details class="step disabled" id="step-3">
                    <summary class="step-header">
                        <h3>Schritt 3: Raum auswählen</h3>
                        <span class="step-status" id="status-step-3">Nicht ausgewählt</span>
                    </summary>
                    <div class="step-content">
                        <p>Wähle den genauen Raum aus.</p>
                        <div id="map-room" class="map-container"></div>
                    </div>
                </details>
            </div>

            <button class="submit-button" id="submitButton">Submit</button>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            
            // --- DOM Referenzen ---
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const step3 = document.getElementById('step-3');
            
            const status1 = document.getElementById('status-step-1');
            const status2 = document.getElementById('status-step-2');
            const status3 = document.getElementById('status-step-3');
            
            // --- Globale Status-Variablen ---
            let selectedLocation = null;
            let selectedFloor = null;
            let selectedRoom = null;

            let worldMap, floorMap, roomMap;
            
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' });
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles &copy; Esri' });

            const defaultIcon = L.icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            const activeIcon = L.icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            let lastFloorLayer = null;
            let lastRoomLayer = null;
            const highlightStyle = {
                weight: 3, color: '#C30012',
                fillColor: '#930010', fillOpacity: 0.6
            };
            const defaultStyle = {
                weight: 2, color: '#333333',
                fillColor: '#777777', fillOpacity: 0.3
            };

            
            // ==========================================================
            // SCHRITT 1: WELTKARTE INITIALISIEREN
            // ==========================================================
            function initWorldMap() {
                worldMap = L.map('map-world').setView([48.7758, 9.1829], 13);
                osmLayer.addTo(worldMap);

                const locations = [
                    { name: "DHBW Stuttgart", lat: 48.7840, lon: 9.1738 },
                    { name: "Hauptbahnhof", lat: 48.7842, lon: 9.1818 },
                    { name: "Milaneo", lat: 48.7895, lon: 9.1852 },
                    { name: "Schlossplatz", lat: 48.7781, lon: 9.1795 },
                ];
                
                let activeMarker = null;

                locations.forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lon], { icon: defaultIcon })
                        .addTo(worldMap)
                        .bindPopup(loc.name);

                    marker.on('click', function() {
                        if (activeMarker) activeMarker.setIcon(defaultIcon);
                        this.setIcon(activeIcon);
                        activeMarker = this;
                        
                        selectedLocation = loc.name;
                        updateStepStatus(status1, `Ausgewählt: ${loc.name}`);
                        
                        // Setze Schritt 2 & 3 zurück und aktiviere Schritt 2
                        resetStep2();
                        resetStep3();
                        step2.classList.remove('disabled');

                        openNextStep(step2);
                        
                        // HIER WÜRDE JETZT DIE LOGIK KOMMEN,
                        // um die korrekte Etagen-Karte für 'loc.name' zu laden
                        // z.B. initFloorMap(loc.name);
                    });
                });
            }

            // ==========================================================
            // SCHRITT 2: ETAGEN-KARTE INITIALISIEREN
            // ==========================================================
            function initFloorMap() {
                if (floorMap) return; 

                floorMap = L.map('map-floor', { crs: L.CRS.Simple, minZoom: -2 });
                const w = 1000, h = 750;
                const imageUrl = 'https://via.placeholder.com/1000x750/F5F5F5/777777?text=Beispiel-Grundriss+Gebaude';
                
                const bounds = [[0,0], [h, w]];
                L.imageOverlay(imageUrl, bounds).addTo(floorMap);
                floorMap.fitBounds(bounds);

                const floorGeoJson = {
                    "type": "FeatureCollection",
                    "features": [
                        { "type": "Feature", "properties": { "name": "Trakt A (EG)" }, "geometry": { "type": "Polygon", "coordinates": [[[50, 50], [450, 50], [450, 700], [50, 700], [50, 50]]] } },
                        { "type": "Feature", "properties": { "name": "Trakt B (EG)" }, "geometry": { "type": "Polygon", "coordinates": [[[500, 50], [950, 50], [950, 700], [500, 700], [500, 50]]] } }
                    ]
                };

                L.geoJSON(floorGeoJson, {
                    style: defaultStyle,
                    onEachFeature: (feature, layer) => {
                        layer.on('click', () => {
                            if (lastFloorLayer) lastFloorLayer.setStyle(defaultStyle);
                            layer.setStyle(highlightStyle);
                            lastFloorLayer = layer;
                            
                            selectedFloor = feature.properties.name;
                            updateStepStatus(status2, `Ausgewählt: ${selectedFloor}`);

                            // Setze Schritt 3 zurück und aktiviere ihn
                            resetStep3();
                            step3.classList.remove('disabled');
                            
                            openNextStep(step3);
                            
                            // HIER WÜRDE LOGIK KOMMEN, um korrekte Raum-Karte zu laden
                            // z.B. initRoomMap(selectedFloor);
                        });
                    }
                }).addTo(floorMap);
            }

            // ==========================================================
            // SCHRITT 3: RAUM-KARTE INITIALISIEREN
            // ==========================================================
            function initRoomMap() {
                if (roomMap) return; 

                roomMap = L.map('map-room', { crs: L.CRS.Simple, minZoom: -2 });
                const w = 1000, h = 750;
                const imageUrl = 'https://via.placeholder.com/1000x750/F5F5F5/777777?text=Beispiel-Grundriss+Trakt+A';
                
                const bounds = [[0,0], [h, w]];
                L.imageOverlay(imageUrl, bounds).addTo(roomMap);
                roomMap.fitBounds(bounds);

                const roomGeoJson = {
                    "type": "FeatureCollection",
                    "features": [
                        { "type": "Feature", "properties": { "name": "Raum A.101" }, "geometry": { "type": "Polygon", "coordinates": [[[50, 50], [300, 50], [300, 300], [50, 300], [50, 50]]] } },
                        { "type": "Feature", "properties": { "name": "Raum A.102" }, "geometry": { "type": "Polygon", "coordinates": [[[50, 350], [300, 350], [300, 700], [50, 700], [50, 350]]] } },
                        { "type": "Feature", "properties": { "name": "Flur" }, "geometry": { "type": "Polygon", "coordinates": [[[350, 50], [950, 50], [950, 700], [350, 700], [350, 50]]] } }
                    ]
                };

                L.geoJSON(roomGeoJson, {
                    style: defaultStyle,
                    onEachFeature: (feature, layer) => {
                        layer.on('click', () => {
                            if (lastRoomLayer) lastRoomLayer.setStyle(defaultStyle);
                            layer.setStyle(highlightStyle);
                            lastRoomLayer = layer;
                            
                            selectedRoom = feature.properties.name;
                            updateStepStatus(status3, `Ausgewählt: ${selectedRoom}`);
                            // Letzter Schritt, nichts mehr öffnen
                        });
                    }
                }).addTo(roomMap);
            }

            // ==========================================================
            // HELFER-FUNKTIONEN
            // ==========================================================

            // Setzt Schritt 2 zurück
            function resetStep2() {
                selectedFloor = null;
                updateStepStatus(status2, 'Nicht ausgewählt', false);
                step2.classList.add('disabled');
                step2.open = false;
                if (lastFloorLayer) {
                    lastFloorLayer.setStyle(defaultStyle);
                    lastFloorLayer = null;
                }
            }

            // Setzt Schritt 3 zurück
            function resetStep3() {
                selectedRoom = null;
                updateStepStatus(status3, 'Nicht ausgewählt', false);
                step3.classList.add('disabled');
                step3.open = false;
                if (lastRoomLayer) {
                    lastRoomLayer.setStyle(defaultStyle);
                    lastRoomLayer = null;
                }
            }
            
            // Aktualisiert den Status-Text (mit 'selected' Klasse an/aus)
            function updateStepStatus(element, text, addClass = true) {
                element.textContent = text;
                if (addClass) {
                    element.classList.add('selected');
                } else {
                    element.classList.remove('selected');
                }
            }

            // Öffnet ein <details> Element
            function openNextStep(stepElement) {
                if (stepElement) {
                    stepElement.open = true;
                }
            }

            // Karten-Layer-Wechsel (Weltkarte)
            document.querySelectorAll('.map-type-button[data-map="world"]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.map-type-button[data-map="world"]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    
                    worldMap.removeLayer(osmLayer);
                    worldMap.removeLayer(satelliteLayer);
                    
                    if (this.dataset.type === 'karte') {
                        osmLayer.addTo(worldMap);
                    } else {
                        satelliteLayer.addTo(worldMap);
                    }
                });
            });

            // --- Akkordeon-Logik: Immer nur ein Schritt offen ---
            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('toggle', function(event) {
                    // Verhindern, dass deaktivierte Schritte manuell geöffnet werden
                    // (Sollte durch CSS pointer-events abgedeckt sein, aber als Fallback)
                    if (this.classList.contains('disabled') && this.open) {
                        this.open = false;
                        return;
                    }
                    
                    // Wenn dieser Schritt geöffnet wird
                    if (this.open) {
                        // Schließe alle anderen
                        document.querySelectorAll('.step').forEach(otherStep => {
                            if (otherStep !== this && otherStep.open) {
                                otherStep.open = false;
                            }
                        });
                        
                        // Karten initialisieren oder Größe anpassen
                        const mapId = this.querySelector('.map-container')?.id;
                        if (mapId) {
                            setTimeout(() => {
                                if (mapId === 'map-world' && worldMap) worldMap.invalidateSize();
                                if (mapId === 'map-floor') {
                                    initFloorMap(); // Initialisieren, falls noch nicht geschehen
                                    if (floorMap) floorMap.invalidateSize();
                                }
                                if (mapId === 'map-room') {
                                    initRoomMap(); // Initialisieren, falls noch nicht geschehen
                                    if (roomMap) roomMap.invalidateSize();
                                }
                            }, 0); // Kurze Verzögerung, damit DOM-Änderung wirksam wird
                        }
                    }
                });
            });

            // Submit & Close Buttons
            document.getElementById('submitButton').addEventListener('click', () => {
                if (!selectedLocation || !selectedFloor || !selectedRoom) {
                    alert('Bitte wählen Sie alle drei Schritte aus.');
                    return;
                }
                
                const selectionSummary = `Ihre Auswahl:\n
                    Standort: ${selectedLocation}\n
                    Etage: ${selectedFloor}\n
                    Raum: ${selectedRoom}\n\n
                    Diese Daten werden nun gesendet.`;
                
                alert(selectionSummary);
                
                document.querySelector('.popup-overlay').style.display = 'none';
            });
            
            document.getElementById('closeButton').addEventListener('click', () => {
                document.querySelector('.popup-overlay').style.display = 'none';
            });

            // ==========================================================
            // INITIALISIERUNG STARTEN
            // ==========================================================
            initWorldMap();
            
        });
    </script>
</body>
</html>