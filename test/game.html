<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHBW360 - Spielansicht</title>

</head>
<body>

    <div id="panorama"></div>

    <div class="ui-overlay">
        <div class="header-logo">
            <img src="dhbw360_logo.png" alt="DHBW360 LogoComponent"> </div>

        <div class="game-info">
            <div class="round-display">Runde X / Y</div>
            <div class="score-display">
                <span>Punkte</span>
                <span class="points">1234</span>
            </div>
        </div>

        <button class="nav-button" id="nav-up" title="Nach oben schauen"></button>
        <button class="nav-button" id="nav-down" title="Nach unten schauen"></button>
        <button class="nav-button" id="nav-left" title="Nach links drehen"></button>
        <button class="nav-button" id="nav-right" title="Nach rechts drehen"></button>

        <button class="map-pin-button" id="openPopupBtn" title="Standort auswählen">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
        </button>
    </div>
    
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content">
            <div class="popup-header">
                <h2>Standortauswahl</h2>
                <button class="close-button" id="closeButton">&times;</button>
            </div>

            <div class="steps-container">
                <details class="step" id="step-1" open>
                    <summary class="step-header">
                        <h3>Schritt 1: Standort auf Karte wählen</h3>
                        <span class="step-status" id="status-step-1">Nicht ausgewählt</span>
                    </summary>
                    <div class="step-content">
                        <div class="map-controls">
                            <button class="map-type-button active" data-map="world" data-type="karte">Karte</button>
                            <button class="map-type-button" data-map="world" data-type="satellit">Satellit</button>
                        </div>
                        <div id="map-world" class="map-container"></div>
                    </div>
                </details>

                <details class="step disabled" id="step-2">
                    <summary class="step-header">
                        <h3>Schritt 2: Etage auswählen</h3>
                        <span class="step-status" id="status-step-2">Nicht ausgewählt</span>
                    </summary>
                    <div class="step-content">
                        <p>Wähle den Gebäudeteil auf dem Grundriss aus.</p>
                        <div id="map-floor" class="map-container"></div>
                    </div>
                </details>

                <details class="step disabled" id="step-3">
                    <summary class="step-header">
                        <h3>Schritt 3: Raum auswählen</h3>
                        <span class="step-status" id="status-step-3">Nicht ausgewählt</span>
                    </summary>
                    <div class="step-content">
                        <p>Wähle den genauen Raum aus.</p>
                        <div id="map-room" class="map-container"></div>
                    </div>
                </details>
            </div>

            <button class="submit-button" id="submitButton">Submit</button>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/pannellum@2.5.6/build/pannellum.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ==========================================================
        // TEIL 1: 360° SPIEL-ANSICHT (PANNELLUM)
        // ==========================================================
        
        // Pannellum Viewer initialisieren
        const viewer = pannellum.viewer('panorama', {
            "type": "equirectangular", // Wir bleiben bei diesem Typ, passen aber die Winkel an
            
            // 1. Verwenden Sie Ihr hochgeladenes Bild 
            "panorama": "raum.jpg",
            "autoLoad": true,
            "showControls": false, // Wir verwenden unsere eigenen Buttons
            "draggable": true,
            "keyboardZoom": false,
            "mouseZoom": false,

            // --- WICHTIGE ÄNDERUNGEN FÜR PARTIELLES PANORAMA ---

            // (Geschätzte) Winkel Ihres Bildes 
            "haov": 360,  // Horizontaler Winkel (z.B. 200 Grad)
            "vaov": 80,   // Vertikaler Winkel (z.B. 80 Grad)
            
            // Start-Blickrichtung (Horizontal)
            "yaw": 0,
            
            // Start-Blickrichtung (Vertikal)
            // (Passen Sie 10 an, um den Blick leicht nach oben/unten zu neigen)
            "pitch": 10,  
            
            // Zoom (Blickfeld des Betrachters)
            "hfov": 100,

            // Verhindert das Scrollen ins Leere (Hälfte von haov/vaov)
           
            "minPitch": -40,
            "maxPitch": 40
        });

        // Eigene Navigations-Buttons
        document.getElementById('nav-up').addEventListener('click', () => viewer.setPitch(viewer.getPitch() + 50));
        document.getElementById('nav-down').addEventListener('click', () => viewer.setPitch(viewer.getPitch() - 50));
        document.getElementById('nav-left').addEventListener('click', () => viewer.setYaw(viewer.getYaw() - 50));
        document.getElementById('nav-right').addEventListener('click', () => viewer.setYaw(viewer.getYaw() + 50));

        // Tastatur-Steuerung
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowUp') {
                viewer.setPitch(viewer.getPitch() + 50);
            } else if (e.key === 'ArrowDown') {
                viewer.setPitch(viewer.getPitch() - 50);
            } else if (e.key === 'ArrowLeft') {
                viewer.setYaw(viewer.getYaw() - 50);
            } else if (e.key === 'ArrowRight') {
                viewer.setYaw(viewer.getYaw() + 50);
            }
        });

        // Popup-Steuerung
        const popupOverlay = document.getElementById('popupOverlay');
        document.getElementById('openPopupBtn').addEventListener('click', () => {
            popupOverlay.style.display = 'flex';
        });


        // ==========================================================
        // TEIL 2: POPUP-LOGIK (Kopiert von vorheriger Antwort)
        // ==========================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');
            const step3 = document.getElementById('step-3');
            
            const status1 = document.getElementById('status-step-1');
            const status2 = document.getElementById('status-step-2');
            const status3 = document.getElementById('status-step-3');
            
            let selectedLocation = null, selectedFloor = null, selectedRoom = null;
            let worldMap, floorMap, roomMap;
            
            const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap' });
            const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles &copy; Esri' });

            const defaultIcon = L.icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });
            const activeIcon = L.icon({
                iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-gold.png',
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
            });

            let lastFloorLayer = null, lastRoomLayer = null;
            const highlightStyle = {
                weight: 3, color: '#C30012',
                fillColor: '#930010', fillOpacity: 0.6
            };
            const defaultStyle = {
                weight: 2, color: '#333333',
                fillColor: '#777777', fillOpacity: 0.3
            };

            
            function initWorldMap() {
                // Prüfen ob Karte schon initialisiert ist
                if (worldMap) {
                    worldMap.invalidateSize();
                    return;
                }
                worldMap = L.map('map-world').setView([48.7758, 9.1829], 13);
                osmLayer.addTo(worldMap);

                const locations = [
                    { name: "DHBW Stuttgart", lat: 48.7840, lon: 9.1738 },
                    { name: "Hauptbahnhof", lat: 48.7842, lon: 9.1818 },
                    { name: "Milaneo", lat: 48.7895, lon: 9.1852 },
                    { name: "Schlossplatz", lat: 48.7781, lon: 9.1795 },
                ];
                let activeMarker = null;
                locations.forEach(loc => {
                    const marker = L.marker([loc.lat, loc.lon], { icon: defaultIcon }).addTo(worldMap).bindPopup(loc.name);
                    marker.on('click', function() {
                        if (activeMarker) activeMarker.setIcon(defaultIcon);
                        this.setIcon(activeIcon);
                        activeMarker = this;
                        
                        selectedLocation = loc.name;
                        updateStepStatus(status1, `Ausgewählt: ${loc.name}`);
                        
                        resetStep2();
                        resetStep3();
                        step2.classList.remove('disabled');
                        openNextStep(step2);
                        // Hier Logik einfügen, um Etagen-Karte basierend auf 'loc.name' zu laden
                    });
                });
            }

            function initFloorMap() {
                if (floorMap) {
                    floorMap.invalidateSize();
                    return;
                }
                floorMap = L.map('map-floor', { crs: L.CRS.Simple, minZoom: -2 });
                const w = 1000, h = 750;
                const imageUrl = 'https://via.placeholder.com/1000x750/F5F5F5/777777?text=Beispiel-Grundriss+Gebaude';
                const bounds = [[0,0], [h, w]];
                L.imageOverlay(imageUrl, bounds).addTo(floorMap);
                floorMap.fitBounds(bounds);

                const floorGeoJson = {
                    "type": "FeatureCollection", "features": [
                        { "type": "Feature", "properties": { "name": "Trakt A (EG)" }, "geometry": { "type": "Polygon", "coordinates": [[[50, 50], [450, 50], [450, 700], [50, 700], [50, 50]]] } },
                        { "type": "Feature", "properties": { "name": "Trakt B (EG)" }, "geometry": { "type": "Polygon", "coordinates": [[[500, 50], [950, 50], [950, 700], [500, 700], [500, 50]]] } }
                    ]
                };
                L.geoJSON(floorGeoJson, {
                    style: defaultStyle,
                    onEachFeature: (feature, layer) => {
                        layer.on('click', () => {
                            if (lastFloorLayer) lastFloorLayer.setStyle(defaultStyle);
                            layer.setStyle(highlightStyle);
                            lastFloorLayer = layer;
                            selectedFloor = feature.properties.name;
                            updateStepStatus(status2, `Ausgewählt: ${selectedFloor}`);
                            resetStep3();
                            step3.classList.remove('disabled');
                            openNextStep(step3);
                            // Hier Logik einfügen, um Raum-Karte basierend auf 'selectedFloor' zu laden
                        });
                    }
                }).addTo(floorMap);
            }

            function initRoomMap() {
                if (roomMap) {
                    roomMap.invalidateSize();
                    return;
                }
                roomMap = L.map('map-room', { crs: L.CRS.Simple, minZoom: -2 });
                const w = 1000, h = 750;
                const imageUrl = 'https://via.placeholder.com/1000x750/F5F5F5/777777?text=Beispiel-Grundriss+Trakt+A';
                const bounds = [[0,0], [h, w]];
                L.imageOverlay(imageUrl, bounds).addTo(roomMap);
                roomMap.fitBounds(bounds);

                const roomGeoJson = {
                    "type": "FeatureCollection", "features": [
                        { "type": "Feature", "properties": { "name": "Raum A.101" }, "geometry": { "type": "Polygon", "coordinates": [[[50, 50], [300, 50], [300, 300], [50, 300], [50, 50]]] } },
                        { "type": "Feature", "properties": { "name": "Raum A.102" }, "geometry": { "type": "Polygon", "coordinates": [[[50, 350], [300, 350], [300, 700], [50, 700], [50, 350]]] } },
                        { "type": "Feature", "properties": { "name": "Flur" }, "geometry": { "type": "Polygon", "coordinates": [[[350, 50], [950, 50], [950, 700], [350, 700], [350, 50]]] } }
                    ]
                };
                L.geoJSON(roomGeoJson, {
                    style: defaultStyle,
                    onEachFeature: (feature, layer) => {
                        layer.on('click', () => {
                            if (lastRoomLayer) lastRoomLayer.setStyle(defaultStyle);
                            layer.setStyle(highlightStyle);
                            lastRoomLayer = layer;
                            selectedRoom = feature.properties.name;
                            updateStepStatus(status3, `Ausgewählt: ${selectedRoom}`);
                        });
                    }
                }).addTo(roomMap);
            }

            function resetStep2() {
                selectedFloor = null;
                updateStepStatus(status2, 'Nicht ausgewählt', false);
                step2.classList.add('disabled');
                step2.open = false;
                if (lastFloorLayer) {
                    lastFloorLayer.setStyle(defaultStyle);
                    lastFloorLayer = null;
                }
            }

            function resetStep3() {
                selectedRoom = null;
                updateStepStatus(status3, 'Nicht ausgewählt', false);
                step3.classList.add('disabled');
                step3.open = false;
                if (lastRoomLayer) {
                    lastRoomLayer.setStyle(defaultStyle);
                    lastRoomLayer = null;
                }
            }
            
            function updateStepStatus(element, text, addClass = true) {
                element.textContent = text;
                if (addClass) element.classList.add('selected');
                else element.classList.remove('selected');
            }

            function openNextStep(stepElement) {
                if (stepElement) stepElement.open = true;
            }

            document.querySelectorAll('.map-type-button[data-map="world"]').forEach(button => {
                button.addEventListener('click', function() {
                    document.querySelectorAll('.map-type-button[data-map="world"]').forEach(btn => btn.classList.remove('active'));
                    this.classList.add('active');
                    worldMap.removeLayer(osmLayer);
                    worldMap.removeLayer(satelliteLayer);
                    if (this.dataset.type === 'karte') osmLayer.addTo(worldMap);
                    else satelliteLayer.addTo(worldMap);
                });
            });

            document.querySelectorAll('.step').forEach(step => {
                step.addEventListener('toggle', function(event) {
                    if (this.classList.contains('disabled') && this.open) {
                        this.open = false;
                        return;
                    }
                    
                    if (this.open) {
                        document.querySelectorAll('.step').forEach(otherStep => {
                            if (otherStep !== this && otherStep.open) otherStep.open = false;
                        });
                        
                        const mapId = this.querySelector('.map-container')?.id;
                        if (mapId) {
                            setTimeout(() => {
                                // Karten initialisieren ODER Größe anpassen
                                if (mapId === 'map-world') initWorldMap();
                                if (mapId === 'map-floor') initFloorMap();
                                if (mapId === 'map-room') initRoomMap();
                            }, 50); // 50ms Verzögerung gibt dem Akkordeon Zeit, sich zu öffnen
                        }
                    }
                });
            });

            document.getElementById('submitButton').addEventListener('click', () => {
                if (!selectedLocation || !selectedFloor || !selectedRoom) {
                    alert('Bitte wählen Sie alle drei Schritte aus.');
                    return;
                }
                alert(`Auswahl:\nStandort: ${selectedLocation}\nEtage: ${selectedFloor}\nRaum: ${selectedRoom}`);
                popupOverlay.style.display = 'none';
            });
            
            document.getElementById('closeButton').addEventListener('click', () => {
                popupOverlay.style.display = 'none';
            });

            // Initialisiere die erste Karte (Weltkarte)
            initWorldMap();
            
        }); // Ende DOMContentLoaded
    </script>
</body>
</html>